alias: EMHASS (Discharge) SOC Change
description: ...
trigger:
  - platform: state
    entity_id:
      - sensor.soc_batt_forecast
    enabled: true
  - platform: time_pattern
    minutes: /5
    enabled: false
condition:
  - condition: numeric_state
    entity_id: sensor.p_batt_forecast
    above: 10
    enabled: true
action:
  - service: huawei_solar.forcible_discharge_soc
    data:
      target_soc: >-
        {% set value = states('sensor.soc_batt_forecast') | int(0) %} {{ value
        if value >= 12 else 12 }}
      power: >-
        {{ states('sensor.p_batt_forecast')|int(0)|abs +
        states('input_number.power_plus')|int(0) }}
      device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
    enabled: true
    alias: huawei_solar.forcible_discharge_soc Forecast + power plus
  - alias: "If SOC lower than 12% then FDC 120 min "
    if:
      - condition: numeric_state
        entity_id: sensor.soc_batt_forecast
        below: 12
    then:
      - service: huawei_solar.forcible_discharge
        metadata: {}
        data:
          duration: 120
          power: >-
            {{ states('sensor.p_batt_forecast')|int(0)|abs +
            states('input_number.power_plus')|int(0) }}
          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
        alias: FC + power plus
    else:
      - service: huawei_solar.forcible_discharge_soc
        data:
          target_soc: >-
            {% set value = states('sensor.soc_batt_forecast') | int(0) %} {{
            value if value >= 12 else 12 }}
          power: >-
            {{ states('sensor.p_batt_forecast')|int(0)|abs +
            states('input_number.power_plus')|int(0) }}
          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
        enabled: true
        alias: huawei_solar.forcible_discharge_soc Forecast + power plus
mode: queued
max: 2
