alias: EMHASS SOC Control
description: ""
triggers:
  - minutes: /2
    id: X-Min
    enabled: true
    trigger: time_pattern
  - entity_id:
      - sensor.p_batt_forecast
    to: "0"
    for:
      hours: 0
      minutes: 0
      seconds: 5
    id: 0W
    trigger: state
  - entity_id: sensor.soc_comparison
    to: same
    for:
      seconds: 5
    id: same
    enabled: true
    trigger: state
  - entity_id: sensor.soc_batt_forecast
    id: Battery SOC Forecast changes
    trigger: state
  - entity_id: sensor.p_batt_forecast
    id: Battery Power Forecast changes
    trigger: state
  - trigger: state
    entity_id:
      - sensor.emhass_battery_mode
    to: Do Nothing
    id: Do Nothing
  - trigger: state
    entity_id:
      - sensor.emhass_battery_mode
    to: Follow Grid
    id: Follow Grid
conditions:
  - condition: state
    entity_id: switch.predbat_set_read_only
    state: "on"
    enabled: false
actions:
  - choose:
      - conditions:
          - condition: trigger
            id:
              - Battery SOC Forecast changes
              - Battery Power Forecast changes
              - X-Min
          - condition: numeric_state
            entity_id: sensor.p_batt_forecast
            below: -50
          - condition: state
            entity_id: sensor.emhass_battery_mode
            state: Forcible Charge
        sequence:
          - alias: 06:00-23:00
            if:
              - condition: time
                after: "06:00:00"
                before: "23:00:00"
            then:
              - action: script.huawei_discharging_power_0w
                data: {}
              - if:
                  - condition: numeric_state
                    entity_id: sensor.p_deferrable0
                    above: 100
                    enabled: true
                then:
                  - action: script.huawei_p_batt_charge_forecast
                    data: {}
                  - action: huawei_solar.forcible_charge_soc
                    data:
                      target_soc: >-
                        {% set value = states('sensor.soc_batt_forecast') |
                        int(0) %} {{ value if value >= 12 else 12 }}
                      power: "5000"
                      device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
                else:
                  - action: script.huawei_limited_power_charge
                    data: {}
                  - action: huawei_solar.forcible_charge_soc
                    data:
                      target_soc: >-
                        {% set value = states('sensor.soc_batt_forecast') |
                        int(0) %} {{ value if value >= 12 else 12 }}
                      power: "5000"
                      device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
          - alias: 23:00-06:00
            if:
              - condition: time
                after: "23:00:00"
                before: "06:00:00"
            then:
              - action: script.huawei_discharging_power_0w
                data: {}
              - if:
                  - condition: numeric_state
                    entity_id: sensor.p_deferrable0
                    above: 100
                    enabled: true
                then:
                  - action: script.huawei_p_batt_charge_forecast
                    data: {}
                  - action: huawei_solar.forcible_charge_soc
                    data:
                      target_soc: >-
                        {% set value = states('sensor.p_batt_forecast') | int(0)
                        %} {{ value if value >= 12 else 12 }}
                      power: "5000"
                      device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
                else:
                  - action: script.huawei_limited_power_charge
                    data: {}
                  - action: huawei_solar.forcible_charge_soc
                    data:
                      target_soc: >-
                        {% set value = states('sensor.p_batt_forecast') | int(0)
                        %} {{ value if value >= 12 else 12 }}
                      power: "5000"
                      device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
        alias: EMHASS (Charge) FC
      - conditions:
          - condition: trigger
            id:
              - Battery SOC Forecast changes
              - X-Min
          - condition: numeric_state
            entity_id: sensor.p_batt_forecast
            above: 50
          - condition: state
            entity_id: sensor.emhass_battery_mode
            state: Forcible Discharge
        sequence:
          - if:
              - condition: numeric_state
                entity_id: sensor.soc_batt_forecast
                below: 12
            then:
              - data:
                  duration: 60
                  power: "{{ (states('sensor.limited_power') | int(0) | abs ) | int }}"
                  device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
                action: huawei_solar.forcible_discharge
            else:
              - data:
                  target_soc: >-
                    {% set value = states('sensor.soc_batt_forecast') | int(0)
                    %} {{ value if value >= 12 else 12 }}
                  power: "{{ (states('sensor.limited_power') | int(0) | abs ) | int }}"
                  device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
                action: huawei_solar.forcible_discharge_soc
        alias: EMHASS (Discharge) FDC
      - conditions:
          - condition: trigger
            id:
              - 0W
              - X-Min
              - Do Nothing
          - condition: and
            conditions:
              - condition: state
                entity_id: sensor.soc_comparison
                state: same
              - condition: state
                entity_id: sensor.p_batt_forecast
                state: "0.00"
              - condition: state
                entity_id: sensor.emhass_battery_mode
                state: Do Nothing
        sequence:
          - data:
              device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
            action: huawei_solar.stop_forcible_charge
        alias: EMHASS (STOP) FDC FC
      - conditions:
          - condition: trigger
            id:
              - 0W
              - same
              - X-Min
              - Do Nothing
          - condition: state
            entity_id: sensor.soc_comparison
            state: same
          - condition: state
            entity_id: sensor.p_batt_forecast
            state: "0.00"
          - condition: state
            entity_id: sensor.emhass_battery_mode
            state: Do Nothing
        sequence:
          - action: script.huawei_charging_power_0w
            data: {}
          - action: script.huawei_discharging_power_0w
            data: {}
        alias: EMHASS (STOP) power
      - conditions:
          - condition: trigger
            id:
              - limited_power
              - Battery Power Forecast changes
              - X-Min
            enabled: true
          - condition: numeric_state
            entity_id: sensor.p_batt_forecast
            above: 50
            enabled: true
          - condition: or
            conditions:
              - condition: state
                entity_id: sensor.emhass_battery_mode
                state: Follow Grid
              - condition: state
                entity_id: sensor.emhass_battery_mode
                state: Forcible Discharge
              - condition: state
                entity_id: sensor.emhass_battery_mode
                state: Forcible Charge
        sequence:
          - action: script.huawei_limited_power_forecast
            data: {}
            enabled: true
        alias: EMHASS (Discharge) Power
      - conditions:
          - condition: trigger
            id:
              - limited_power
              - Battery Power Forecast changes
              - X-Min
            enabled: true
          - condition: numeric_state
            entity_id: sensor.p_batt_forecast
            enabled: true
            below: 50
          - condition: or
            conditions:
              - condition: state
                entity_id: sensor.emhass_battery_mode
                state: Follow Grid
              - condition: state
                entity_id: sensor.emhass_battery_mode
                state: Forcible Charge
        sequence:
          - action: script.huawei_p_batt_forecast
            data: {}
            enabled: false
          - action: script.huawei_limited_power_charge
            data: {}
            enabled: true
        alias: EMHASS (Charge) Power
      - conditions:
          - condition: trigger
            id:
              - Battery Power Forecast changes
              - X-Min
              - Follow Grid
            enabled: true
          - condition: numeric_state
            entity_id: sensor.p_batt_forecast
            above: 50
            enabled: true
          - condition: state
            entity_id: sensor.emhass_battery_mode
            state: Follow Grid
        sequence:
          - action: script.huawei_p_batt_forecast
            data: {}
          - if:
              - condition: numeric_state
                entity_id: sensor.inverter_input_power
                above: 1500
            then:
              - action: script.huawei_charging_power_5000w
                data: {}
            else:
              - action: script.huawei_charging_power_0w
                data: {}
        alias: EMHASS (Discharge) Power Follow grid
mode: parallel
max: 10
