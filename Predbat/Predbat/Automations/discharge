alias: "Predbat Discharge "
description: ""
triggers:
  - entity_id:
      - binary_sensor.predbat_exporting
    id: Predbat_export_on
    trigger: state
    to: "on"
  - trigger: state
    entity_id:
      - predbat.status
    to: Exporting
    enabled: true
  - entity_id:
      - binary_sensor.predbat_exporting
    id: Predbat_export_off
    trigger: state
    to: "off"
  - trigger: time_pattern
    minutes: /3
    enabled: false
conditions:
  - condition: state
    entity_id: automation.emhass_combined_automation
    state: "off"
  - condition: state
    entity_id: automation.tibber_smartcharge
    state: "off"
actions:
  - if:
      - condition: numeric_state
        entity_id: sensor.predicted_export_limit_percent_best
        below: 12
    then:
      - data:
          duration: 60
          power: "4500"
          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
        action: huawei_solar.forcible_discharge
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - action: script.huawei_discharging_power_4500w
        data: {}
    else:
      - action: huawei_solar.forcible_discharge_soc
        data:
          target_soc: >-
            {% set value = states('predbat.best_export_limit') | int(0) %} {{
            value if value >= 12 else 12 }}
          power: "4500"
          device_id: 6893ee838a0972bd3e50d9e0faa0ba5a
      - delay:
          hours: 0
          minutes: 0
          seconds: 10
          milliseconds: 0
      - action: script.huawei_discharging_power_4500w
        data: {}
  - if:
      - condition: state
        entity_id: binary_sensor.predbat_exporting
        state: "off"
    then:
      - action: huawei_solar.stop_forcible_charge
        data: {}
  - delay:
      hours: 0
      minutes: 0
      seconds: 10
      milliseconds: 0
    enabled: false
mode: parallel
max: 10
